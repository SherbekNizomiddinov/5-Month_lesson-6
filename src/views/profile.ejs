<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Auth System</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë§</text></svg>">
</head>
<body>
    <!-- Orqaga tugmasi brauzerni tepasida -->
    <button class="browser-back-button" onclick="window.location.href='/'">
        üè† Bosh sahifa
    </button>

    <div class="profile-container">
        <div class="profile-content-wrapper">
            <div class="profile-header">
                <div class="profile-title">
                    <h1>üë§ Profil</h1>
                    <p class="profile-subtitle">Shaxsiy ma'lumotlaringizni ko'ring va tahrirlang</p>
                </div>
                <div class="profile-actions">
                    <button class="edit-btn" id="editProfileBtn">
                        ‚úèÔ∏è Tahrirlash
                    </button>
                    <button class="logout-btn" onclick="authManager.logout()">
                        üö™ Chiqish
                    </button>
                </div>
            </div>

            <div class="profile-content" id="profileContent">
                <!-- Loading holati -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p>Ma'lumotlar yuklanmoqda...</p>
                </div>

                <!-- Xatolik holati -->
                <div class="error" id="errorState" style="display: none;">
                    <h3>‚ùå Xatolik yuz berdi</h3>
                    <p id="errorMessage">Ma'lumotlarni yuklashda xatolik yuz berdi</p>
                    <button class="retry-btn" onclick="loadProfile()">
                        üîÑ Qaytadan urinish
                    </button>
                </div>

                <!-- Profil ma'lumotlari -->
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="info-item">
                        <label>üë§ To'liq ism:</label>
                        <span id="userName">-</span>
                    </div>
                    
                    <div class="info-item">
                        <label>üìß Email manzil:</label>
                        <span id="userEmail">-</span>
                    </div>
                    
                    <div class="info-item">
                        <label>üè∑Ô∏è Rol:</label>
                        <span id="userRole">-</span>
                    </div>
                    
                    <div class="info-item">
                        <label>üìÖ Ro'yxatdan o'tgan sana:</label>
                        <span id="userCreatedAt">-</span>
                    </div>
                    
                    <div class="info-item">
                        <label>üîÑ Oxirgi yangilanish:</label>
                        <span id="userUpdatedAt">-</span>
                    </div>
                    
                    <div class="info-item">
                        <label>‚úÖ Akkount holati:</label>
                        <span id="userStatus" class="active">Faol</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profil tahrirlash modali -->
    <div class="modal" id="editModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Profilni tahrirlash</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            
            <form class="modal-form" id="editForm">
                <div class="input-group">
                    <label class="form-label" for="editName">
                        üë§ To'liq ism
                    </label>
                    <input 
                        type="text" 
                        id="editName" 
                        name="name" 
                        class="form-input" 
                        required
                        minlength="2"
                    >
                </div>
                
                <div class="input-group">
                    <label class="form-label" for="editEmail">
                        üìß Email manzil
                    </label>
                    <input 
                        type="email" 
                        id="editEmail" 
                        name="email" 
                        class="form-input" 
                        required
                    >
                </div>
            </form>
            
            <div class="modal-actions">
                <button class="cancel-btn" id="cancelEdit">Bekor qilish</button>
                <button class="save-btn" id="saveProfile">üíæ Saqlash</button>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let currentUser = null;
        let profileLoaded = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Profile page loaded");
            
            // Redirect loop ni oldini olish
            if (profileLoaded) {
                console.log("Profile already loaded, skipping");
                return;
            }
            profileLoaded = true;

            // Authentication tekshiruvi
            if (typeof authManager === 'undefined') {
                console.log("AuthManager not found, redirecting to login");
                window.location.href = '/login';
                return;
            }

            if (!authManager.isAuthenticated()) {
                console.log("User not authenticated, redirecting to login");
                window.location.href = '/login';
                return;
            }

            console.log("User authenticated, loading profile");

            // Profil ma'lumotlarini yuklash
            loadProfile();

            // Modal boshqaruvi
            setupModalHandlers();
        });

        function setupModalHandlers() {
            const editProfileBtn = document.getElementById('editProfileBtn');
            const editModal = document.getElementById('editModal');
            const closeModal = document.getElementById('closeModal');
            const cancelEdit = document.getElementById('cancelEdit');
            const saveProfile = document.getElementById('saveProfile');

            if (editProfileBtn) editProfileBtn.addEventListener('click', openEditModal);
            if (closeModal) closeModal.addEventListener('click', closeEditModal);
            if (cancelEdit) cancelEdit.addEventListener('click', closeEditModal);
            if (saveProfile) saveProfile.addEventListener('click', saveProfileChanges);

            // Modal tashqarisini bosish orqali yopish
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === editModal) {
                        closeEditModal();
                    }
                });
            }
        }

        // Profil ma'lumotlarini yuklash
        async function loadProfile() {
            console.log("Loading profile data...");
            
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const userInfo = document.getElementById('userInfo');

            // Loading holatini ko'rsatish
            if (loadingState) loadingState.style.display = 'flex';
            if (errorState) errorState.style.display = 'none';
            if (userInfo) userInfo.style.display = 'none';

            try {
                const result = await authManager.getProfile();
                console.log("Profile result:", result);
                
                if (result.success && result.user) {
                    currentUser = result.user;
                    displayUserInfo(result.user);
                    
                    // Ma'lumotlarni ko'rsatish
                    if (loadingState) loadingState.style.display = 'none';
                    if (userInfo) userInfo.style.display = 'block';
                
                console.log("Profile loaded successfully");
            } else {
                throw new Error(result.message || 'Profil ma\'lumotlarini olishda xatolik');
            }
        } catch (error) {
            console.error('Profile load error:', error);
            
            // Xatolikni ko'rsatish
            if (loadingState) loadingState.style.display = 'none';
            if (errorState) errorState.style.display = 'block';
            
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = error.message || 'Ma\'lumotlarni yuklashda xatolik yuz berdi';
            }
        }
    }

    // Foydalanuvchi ma'lumotlarini ko'rsatish
    function displayUserInfo(user) {
        console.log("Displaying user info:", user);
        
        const elements = {
            userName: document.getElementById('userName'),
            userEmail: document.getElementById('userEmail'),
            userRole: document.getElementById('userRole'),
            userCreatedAt: document.getElementById('userCreatedAt'),
            userUpdatedAt: document.getElementById('userUpdatedAt'),
            userStatus: document.getElementById('userStatus')
        };

        if (elements.userName) elements.userName.textContent = user.name || '-';
        if (elements.userEmail) elements.userEmail.textContent = user.email || '-';
        
        // Rolni ko'rsatish
        if (elements.userRole) {
            const roleText = user.role === 'admin' ? 'üëë Administrator' : 
                           user.role === 'moderator' ? 'üõ°Ô∏è Moderator' : 
                           'üë§ Foydalanuvchi';
            elements.userRole.textContent = roleText;
        }
        
        // Sanalarni formatlash
        if (elements.userCreatedAt) {
            const createdDate = user.createdAt ? formatDate(user.createdAt) : '-';
            elements.userCreatedAt.textContent = createdDate;
        }
        
        if (elements.userUpdatedAt) {
            const updatedDate = user.updatedAt ? formatDate(user.updatedAt) : '-';
            elements.userUpdatedAt.textContent = updatedDate;
        }
        
        // Holat
        if (elements.userStatus) {
            if (user.isActive !== false) {
                elements.userStatus.textContent = 'üü¢ Faol';
                elements.userStatus.className = 'active';
            } else {
                elements.userStatus.textContent = 'üî¥ Nofaol';
                elements.userStatus.className = 'inactive';
            }
        }
    }

    // Sanani formatlash
    function formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('uz-UZ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            console.error("Date format error:", error);
            return dateString;
        }
    }

    // Tahrirlash modalini ochish
    function openEditModal() {
        if (!currentUser) {
            console.log("No current user data");
            return;
        }
        
        const editModal = document.getElementById('editModal');
        const editName = document.getElementById('editName');
        const editEmail = document.getElementById('editEmail');
        
        if (!editModal || !editName || !editEmail) {
            console.log("Modal elements not found");
            return;
        }
        
        // Joriy ma'lumotlarni modalga yuklash
        editName.value = currentUser.name || '';
        editEmail.value = currentUser.email || '';
        
        editModal.style.display = 'flex';
        editName.focus();
    }

    // Tahrirlash modalini yopish
    function closeEditModal() {
        const editModal = document.getElementById('editModal');
        if (editModal) {
            editModal.style.display = 'none';
        }
    }

    // Profil o'zgarishlarini saqlash
    async function saveProfileChanges() {
        const editName = document.getElementById('editName');
        const editEmail = document.getElementById('editEmail');
        const saveBtn = document.getElementById('saveProfile');
        
        if (!editName || !editEmail || !saveBtn) {
            console.log("Form elements not found");
            return;
        }
        
        // Validation
        if (!editName.value.trim()) {
            alert('Ism kiritish majburiy');
            editName.focus();
            return;
        }
        
        if (!editEmail.value.trim()) {
            alert('Email kiritish majburiy');
            editEmail.focus();
            return;
        }
        
        if (!/\S+@\S+\.\S+/.test(editEmail.value)) {
            alert('Email formati noto\'g\'ri');
            editEmail.focus();
            return;
        }
        
        const originalText = saveBtn.innerHTML;
        
        try {
            // Loading holati
            saveBtn.innerHTML = '<div class="spinner"></div><span>Saqlanmoqda...</span>';
            saveBtn.disabled = true;
            
            // Demo uchun - haqiqiy API chaqiruvi o'rniga
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Ma'lumotlarni yangilash
            currentUser.name = editName.value.trim();
            currentUser.email = editEmail.value.trim();
            currentUser.updatedAt = new Date().toISOString();
            
            // LocalStorage ni yangilash
            localStorage.setItem('user', JSON.stringify(currentUser));
            
            // UI ni yangilash
            displayUserInfo(currentUser);
            
            // Muvaffaqiyat
            saveBtn.innerHTML = '‚úÖ Saqlandi!';
            setTimeout(() => {
                closeEditModal();
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }, 1500);
            
        } catch (error) {
            console.error('Save profile error:', error);
            alert('Saqlashda xatolik yuz berdi. Qaytadan urinib ko\'ring.');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape tugmasi bilan modalni yopish
        if (e.key === 'Escape') {
            closeEditModal();
        }
        
        // Ctrl+E bilan tahrirlash modalini ochish
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            openEditModal();
        }
    });

    // Global functions
    window.loadProfile = loadProfile;
</script>
</body>
</html>
